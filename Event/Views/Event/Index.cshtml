@{
    ViewData["Title"] = "Tours Management";
}

<link rel="stylesheet" href="~/lib/kendo/kendo.default-v2.min.css" />
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/kendo/kendo.all.min.js"></script>

<div class="container mt-4">

    <h2 class="mb-4">Tours Management</h2>

    @*-----------  grid-1 ------------  *@
    <h4>Available Event</h4>
    <div id="grid"></div>
    <br />

    @*----------- grid -2 ------------ *@
    <h4>Your Bookings</h4>
    <div id="grid1"></div>
    <br />

    <!-- EDIT WINDOW -->
    <div id="editWindow" style="display:none;">

        <label>Event Seats:</label>
        <input type="text" id="editSeats" class="k-textbox" />

        <br /><br />

        <label>Booking Date:</label>
        <input id="editDate" style="width:100%;" />

        <input type="hidden" id="editBookingId" />

        <br /><br />
        <button class="k-button k-button-solid-primary" onclick="saveEdit()">Update</button>

    </div>


</div>

<script>

    var editWnd;

    $(document).ready(function () {

        loadGrid();
        loadBookedGrid();

        // EDIT POPUP INIT
        editWnd = $("#editWindow").kendoWindow({
            title: "Edit Booking",
            width: "350px",
            height: "260px",
            visible: false,
            modal: true
        }).data("kendoWindow");

        // DATE PICKER INIT
        $("#editDate").kendoDatePicker({
            format: "yyyy-MM-dd",
            min: new Date()
        });


    });

    // =============================
    // GRID 1 → Available Tours
    // =============================
    function loadGrid() {
        $("#grid").kendoGrid({
            dataSource: {
                transport: { read: "/Event/GetAll" },
                pageSize: 10
            },
            pageable: true,
            sortable: true,

            columns: [
                { field: "c_eventId", title: "Event ID", width: 100 },
                { field: "c_eventname", title: "Event Name" },
                { field: "c_eventprice", title: "Event Price" },
                { field: "c_eventseats", title: "Event Seats" },
                { field: "c_eventdate", title: "Event Date", format: "{0:yyyy-MM-dd}" },
                { field: "c_address", title: "Event Address" },
                {
                    title: "Actions",
                    width: 150,
                    template: `
                        <button class="k-button k-button-solid-primary btnBooking">
                            Book
                        </button>
                    `
                }
            ]
        });
    }

    // =============================
    // GRID 2 → Logged-in user's bookings
    // =============================
    function loadBookedGrid() {
        $("#grid1").kendoGrid({
            dataSource: {
                transport: { read: "/Event/GetBookings" },
                pageSize: 10
            },
            pageable: true,
            sortable: true,

            columns: [
                { field: "c_bookingid", title: "Booking ID", width: 80 },
                { field: "c_userid", title: "User ID", width: 80 },
                { field: "c_eventid", title: "Event ID", width: 80 },
                { field: "c_eventseats", title: "Event Seats", width: 80 },
                { field: "c_eventprice", title: "Event Price", width: 100 },
                { field: "c_status", title: "Status", width: 100 },
                { field: "c_eventdate", title: "Event Date", format: "{0:yyyy-MM-dd}", width: 120 },

                {
                    title: "Actions",
                    width: 200,
                    template: `
                        <button class="k-button k-button-solid-info" onclick="editBooking(#=c_bookingid#)">Edit</button>
                        <button class="k-button k-button-solid-error" onclick="deleteBooking(#=c_bookingid#)">Delete</button>
                    `
                }
            ]
        });
    }

    // =============================
    // BOOK TOUR
    // =============================
    $(document).on("click", ".btnBooking", function () {

        var grid = $("#grid").data("kendoGrid");
        var row = $(this).closest("tr");
        var dataItem = grid.dataItem(row);

        var booking = {
            c_userid: dataItem.c_userid,
            c_eventid: 1,
            c_eventseats: 1,
            c_eventprice: dataItem.c_eventprice,
            c_status: "Confirmed",
            c_eventdate: dataItem.c_eventdate,
        };

        $.ajax({
            url: "/Event/SaveBooking",
            type: "POST",
            data: JSON.stringify(booking),
            contentType: "application/json",

            success: function (res) {
                if (res.success) {
                    alert("Booking Completed!");
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
                else {
                    alert("Failed to Book!");
                }
            }
        });
    });

    // =============================
    // EDIT BOOKING POPUP
    // =============================
    function editBooking(id) {

        $.get("/Event/GetBookings", function (data) {

            var booking = data.find(x => x.c_bookingid === id);

            $("#editBookingId").val(booking.c_bookingid);
            $("#editSeats").val(booking.c_eventseats);
            $("#editDate").data("kendoDatePicker").value(new Date(booking.c_eventdate));

            editWnd.center().open();
        });
    }

    // =============================
    // SAVE UPDATED BOOKING
    // =============================
    function saveEdit() {

        var booking = {
            c_bookingid: $("#editBookingId").val(),
            c_eventseats: $("#editSeats").val(),
            c_eventdate: $("#editDate").val()
        };

        $.ajax({
            url: "/Event/UpdateBooking",
            type: "POST",
            data: JSON.stringify(booking),
            contentType: "application/json",

            success: function (res) {
                if (res.success) {
                    alert("Booking Updated!");
                    editWnd.close();
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
            }
        });
    }

    // =============================
    // DELETE BOOKING
    // =============================
    function deleteBooking(id) {

        if (!confirm("Are you sure you want to delete this booking?"))
            return;

        $.ajax({
            url: "/Event/DeleteBooking?id=" + id,
            type: "POST",

            success: function (res) {
                if (res.success) {
                    alert("Booking Deleted!");
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
            }
        });
    }






















</script>