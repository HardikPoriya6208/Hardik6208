@{
    ViewData["Title"] = "Tours Management";
}

<link rel="stylesheet" href="~/lib/kendo/kendo.default-v2.min.css" />
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/kendo/kendo.all.min.js"></script>

<div class="container mt-4">

    <h2 class="mb-4">Flight Management</h2>

    <h4>Available Flight</h4>
    <div id="grid"></div>
    <br />

    <h4>Your Bookings</h4>
    <div id="grid1"></div>
    <br />

    <!-- EDIT WINDOW -->
    <div id="editWindow" style="display:none;">


        <label>Booking Date:</label>
        <input id="editDate" style="width:100%;" />

        <br /><br />

        <label>TotalSeats</label>
        <input id="totalSeats" style="width:100%;" />

        <br /><br />

        <label>Departure</label>
        <input id="departure" style="width:100%;" />


        <input type="hidden" id="editBookingId" />

        <br /><br />
        <button class="k-button k-button-solid-primary" onclick="saveEdit()">Update</button>

    </div>


</div>

<script>

    var editWnd;

    $(document).ready(function () {

        loadGrid();
        loadBookedGrid();

        // EDIT POPUP INIT
        editWnd = $("#editWindow").kendoWindow({
            title: "Edit Booking",
            width: "350px",
            height: "260px",
            visible: false,
            modal: true
        }).data("kendoWindow");

        // DATE PICKER INIT
        $("#editDate").kendoDatePicker({
            format: "yyyy-MM-dd",
            min: new Date()
        });

    });

    // =============================
    // GRID 1 → Available Tours
    // =============================
    function loadGrid() {
        $("#grid").kendoGrid({
            dataSource: {
                transport: { read: "/Flight/GetAll" },
                pageSize: 10
            },
            pageable: true,
            sortable: true,

            columns: [
                { field: "t_flightId", title: "Flight ID", width: 100 },
                { field: "t_flightno", title: "Flight No" },
                { field: "t_departure", title: "Departure" },
                { field: "t_destination", title: "Destination" },
                { field: "t_date", title: "Tours Date", format: "{0:yyyy-MM-dd}" },
                { field: "t_totalSeats", title: "Total Seats" },
                { field: "t_price", title: "Flight Price" },


                {
                    title: "Actions",
                    width: 150,
                    template: `
                        <button class="k-button k-button-solid-primary btnBooking">
                            Book
                        </button>
                    `
                }
            ]
        });
    }

    // =============================
    // GRID 2 → Logged-in user's bookings
    // =============================
    function loadBookedGrid() {
        $("#grid1").kendoGrid({
            dataSource: {
                transport: { read: "/Flight/GetBookings" },
                pageSize: 10
            },
            pageable: true,
            sortable: true,

            columns: [
                { field: "t_bookingId", title: "Booking ID", width: 80 },
                { field: "c_userid", title: "UserID ID", width: 80 },
                { field: "t_flightId", title: "fligh ID", width: 80 },
                { field: "t_departure", title: "Departure", width: 80 },
                { field: "t_totalSeats", title: "Total Seats", width: 100 },
                { field: "t_date", title: "Booking Date", format: "{0:yyyy-MM-dd}", width: 120 },

                {
                    title: "Actions",
                    width: 200,
                    template: `
                        <button class="k-button k-button-solid-info" onclick="editBooking(#=t_bookingId#)">Edit</button>
                        <button class="k-button k-button-solid-error" onclick="deleteBooking(#=t_bookingId#)">Delete</button>
                    `
                }
            ]
        });
    }


    // =============================
    // BOOK TOUR
    // =============================
    $(document).on("click", ".btnBooking", function () {

        var grid = $("#grid").data("kendoGrid");
        var row = $(this).closest("tr");
        var dataItem = grid.dataItem(row);

        var booking = {
            c_userid: dataItem.c_userid,
            t_flightId: dataItem.t_flightId,
            t_departure: dataItem.t_departure,
            t_totalSeats: 1,
            t_date: dataItem.t_date,
        };

        $.ajax({
            url: "/Flight/SaveBooking",
            type: "POST",
            data: JSON.stringify(booking),
            contentType: "application/json",

            success: function (res) {
                if (res.success) {
                    alert("Booking Completed!");
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
                else {
                    alert("Failed to Book!");
                }
            }
        });
    });

    // =============================
    // DELETE BOOKING
    // =============================
    function deleteBooking(id) {

        if (!confirm("Are you sure you want to delete this booking?"))
            return;

        $.ajax({
            url: "/Flight/DeleteBooking?id=" + id,
            type: "POST",

            success: function (res) {
                if (res.success) {
                    alert("Booking Deleted!");
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
            }
        });
    }

    // =============================
    // EDIT BOOKING POPUP
    // =============================
    function editBooking(id) {

        $.get("/Flight/GetBookings", function (data) {

            var booking = data.find(x => x.t_bookingId === id);

            $("#editBookingId").val(booking.t_bookingId);
            $("#totalSeats").val(booking.t_totalSeats);
            $("#departure").val(booking.t_departure);
            $("#editDate").data("kendoDatePicker").value(new Date(booking.t_date));

            editWnd.center().open();
        });
    }

    // =============================
    // SAVE UPDATED BOOKING
    // =============================
    function saveEdit() {

        var booking = {
            t_bookingId: $("#editBookingId").val(),
            t_totalSeats: $("#totalSeats").val(),
            t_departure: $("#departure").val(),
            t_date: $("#editDate").val()
        };

        $.ajax({
            url: "/Flight/UpdateBooking",
            type: "POST",
            data: JSON.stringify(booking),
            contentType: "application/json",

            success: function (res) {
                if (res.success) {
                    alert("Booking Updated!");
                    editWnd.close();
                    $("#grid1").data("kendoGrid").dataSource.read();
                }
            }
        });
    }














</script>